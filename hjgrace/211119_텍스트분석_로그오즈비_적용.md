# 로그 오즈비 함수

> - 로그오즈비는 빈도분석과 함께 진행해야 한다.

```python
# 빈도분석 후 결과 출력
def count_analyze(texts, count_vec, color, title):
    
    count_vec.fit(texts)
    
    word_dict = sorted(count_vec.vocabulary_.items())
    idx2word = {idx:word for word, idx in word_dict}

    total_text = []
    total_text.append(' '.join(texts.values))

    count_matrix = count_vec.transform(total_text)

    count_word = []
    count_vector = []

    for i in range(20,0,-1):
        count_word.append(idx2word[(-count_matrix.toarray()[0]).argsort()[i-1]])
        count_vector.append(count_matrix.toarray()[0][(-count_matrix.toarray()[0]).argsort()[i-1]])

    print(count_word)
    print(count_vector)

    plt.figure(figsize=(12,16))
    plt.barh(count_word, count_vector, color=color)
    plt.yticks(count_word)
    plt.title(f'{title} 빈도 분석')
    plt.show()

    return count_word, count_vector


# 로그 오즈비 구하기
def log_odds_ratio(count_vec, prepro_data1, prepro_data2, count_word1, count_word2, title):

  # 빈도분석으로 뽑은 단어들 공통 단어 빼고, 유일한 단어들로 정리
  count_word_list = list(set(count_word1 + count_word2))

  #################################################################
  # 첫 번째 (기준 데이터)
  # 기준으로 정한 데이터로 다시 적합시키기
  count_vec.fit(prepro_data1)

  # 우리가 원하는 빈도 수치 뽑기 위한 데이터 정리
  join_text1 = []
  join_text1.append(' '.join(prepro_data1.values))

  # 빈도 뽑아내기
  count_transform1 = count_vec.transform(join_text1)

  # 단어사전 만들기
  word2idx1 = {word:idx for word, idx in count_vec.vocabulary_.items()}

  # 첫번째 데이터에 대한 확인 할 단어 빈도 수치 뽑기
  text_vector1 = []
  for word in count_word_list:
    if word in word2idx1.keys():
      text_vector1.append(count_transform1.toarray()[0][word2idx1[word]])
    else:
      text_vector1.append(0)

  #################################################################

  # 두 번째 (비교 데이터)
  # 다시 적합시키기
  count_vec.fit(prepro_data2)

  # 우리가 원하는 빈도 수치 뽑기 위한 데이터 정리
  join_text2 = []
  join_text2.append(' '.join(prepro_data2.values))

  # 빈도 뽑아내기
  count_transform2 = count_vec.transform(join_text2)

  # 단어사전 만들기
  word2idx2 = {word:idx for word, idx in count_vec.vocabulary_.items()}

  # 두번째 데이터에 대한 확인 할 단어 빈도 수치 뽑기
  text_vector2 = []
  for word in count_word_list:
    if word in word2idx2.keys():
      text_vector2.append(count_transform2.toarray()[0][word2idx2[word]])
    else:
      text_vector2.append(int(0))

  #################################################################

  # 빈도 수치 데이터 프레임 만들기
  count_df = pd.DataFrame({
      'word' : count_word_list,
      'data1' : text_vector1,
      'data2' : text_vector2
  })

  # count_df.sort_values(by='data1', axis=0, ascending=False, inplace=True)
  count_df['odds1'] = (count_df['data1']/sum(count_df['data1'])) / (1 - (count_df['data1']/sum(count_df['data1']))) # 기준데이터 odds 구하기
  count_df['odds2'] = (count_df['data2']/sum(count_df['data2'])) / (1 - (count_df['data2']/sum(count_df['data2']))) # 비교데이터 odds 구하기
  count_df['odds_ratio'] = count_df['odds1'] / count_df['odds2']  # ==> 오즈비 구하기
  count_df['log_odds_ratio'] = np.log(count_df['odds_ratio'])     # ==> 로그 오즈비 구하기
  count_df.sort_values(by='log_odds_ratio', ascending=False, inplace=True)  # ==> 로그 오즈비 기준으로 내림차순 정렬하기
  count_df['positive'] = count_df['log_odds_ratio'] > 0

  # 무한대값은 제거하자
  count_df = count_df[count_df['log_odds_ratio'] != np.inf]

  plt.barh(count_df['word'].values[::-1], count_df['log_odds_ratio'].values[::-1], color=count_df['positive'][::-1].map({True:'skyblue', False:'lightpink'}))
  plt.title(f'{title} 로그오즈비 비교')
  plt.yticks(count_df['word'].values[::-1])
  plt.show()

  return count_df
```



# 빈도분석으로 대표 단어 선정

```python
# 빈도 구하기
q1_gender_stop_words = ['있는', '하는', '생각']

# CountVectorizer
q1_gender_count = CountVectorizer(
    stop_words = q1_gender_stop_words,
    max_features = 100,
    min_df = 100
)

# q1_male_word에 빈도 Top20 단어가 들어갈 예정
q1_male_word, q1_male_vec = count_analyze(prepro_male_q1, q1_gender_count, 'tab:blue', '남성')
q1_female_word, q1_female_vec = count_analyze(prepro_female_q1, q1_gender_count, 'tab:red', '여성')
```



# 대표 단어로 로그오즈비 구하기

```python
# 사용자 정의 함수 log_odds_ratio 참고
q1_gender_log_df = log_odds_ratio(q1_gender_count, prepro_male_q1, prepro_female_q1, q1_male_word, q1_female_word, 'Q1_남여')
```

